<!DOCTYPE html>
<html lang="en">
  <head>
    <title>DesignRationale  Reference</title>
    <link rel="stylesheet" type="text/css" href="css/jazzy.css" />
    <link rel="stylesheet" type="text/css" href="css/highlight.css" />
    <meta charset='utf-8'>
    <script src="js/jquery.min.js" defer></script>
    <script src="js/jazzy.js" defer></script>
    
  </head>
  <body>
    <a title="DesignRationale  Reference"></a>
    <header>
      <div class="content-wrapper">
        <p><a href="index.html">NexmoConversation Docs</a> (66% documented)</p>
        <p class="header-right"><a href="https://github.com/Nexmo/conversation-ios-sdk"><img src="img/gh.png"/>View on GitHub</a></p>
      </div>
    </header>
    <div class="content-wrapper">
      <p id="breadcrumbs">
        <a href="index.html">NexmoConversation Reference</a>
        <img id="carat" src="img/carat.png" />
        DesignRationale  Reference
      </p>
    </div>
    <div class="content-wrapper">
      <nav class="sidebar">
        <ul class="nav-groups">
          <li class="nav-group-name">
            <a href="Client.html">Client</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a href="Classes/ConversationClient.html">ConversationClient</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/ConversationClient/LoginResult.html">– LoginResult</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/ConversationClient/State.html">– State</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/ConversationClient/StateObjc.html">– StateObjc</a>
              </li>
              <li class="nav-group-task">
                <a href="Enums/SynchronizingState.html">SynchronizingState</a>
              </li>
            </ul>
          </li>
          <li class="nav-group-name">
            <a href="Configuration.html">Configuration</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a href="Structs/Configuration.html">Configuration</a>
              </li>
              <li class="nav-group-task">
                <a href="Structs/Configuration/LogLevel.html">– LogLevel</a>
              </li>
            </ul>
          </li>
          <li class="nav-group-name">
            <a href="Facade.html">Facade</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a href="Classes/Conversation.html">Conversation</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/Conversation/Media.html">– Media</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/Conversation/Errors.html">– Errors</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/Member.html">Member</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/ReceiptRecord.html">ReceiptRecord</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/ReceiptRecord/ReceiptState.html">– ReceiptState</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/User.html">User</a>
              </li>
            </ul>
          </li>
          <li class="nav-group-name">
            <a href="Controller.html">Controller</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a href="Classes/AccountController.html">AccountController</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/AccountController/State.html">– State</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/ConversationController.html">ConversationController</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/ConversationController/JoinConversation.html">– JoinConversation</a>
              </li>
            </ul>
          </li>
          <li class="nav-group-name">
            <a href="Event.html">Event</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a href="Classes/EventBase.html">EventBase</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/EventBase/EventType.html">– EventType</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/TextEvent.html">TextEvent</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/ImageEvent.html">ImageEvent</a>
              </li>
              <li class="nav-group-task">
                <a href="Event.html#/c:@M@NexmoConversation@objc(cs)NXMMembershipEvent">MembershipEvent</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/MemberLeftEvent.html">MemberLeftEvent</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/MemberJoinedEvent.html">MemberJoinedEvent</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/MemberInvitedEvent.html">MemberInvitedEvent</a>
              </li>
            </ul>
          </li>
          <li class="nav-group-name">
            <a href="Model.html">Model</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a href="Classes/Event.html">Event</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/Event/EventType.html">– EventType</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/ConversationModel.html">ConversationModel</a>
              </li>
              <li class="nav-group-task">
                <a href="Structs/MemberModel.html">MemberModel</a>
              </li>
              <li class="nav-group-task">
                <a href="Structs/MemberModel/State.html">– State</a>
              </li>
              <li class="nav-group-task">
                <a href="Structs/MemberModel/Action.html">– Action</a>
              </li>
              <li class="nav-group-task">
                <a href="Structs/MemberModel/Channel.html">– Channel</a>
              </li>
              <li class="nav-group-task">
                <a href="Structs/NetworkError.html">NetworkError</a>
              </li>
              <li class="nav-group-task">
                <a href="Structs/PushNotificationCertificate.html">PushNotificationCertificate</a>
              </li>
              <li class="nav-group-task">
                <a href="Structs/Session.html">Session</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/ConversationPreviewModel.html">ConversationPreviewModel</a>
              </li>
            </ul>
          </li>
          <li class="nav-group-name">
            <a href="Collection.html">Collection</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a href="Classes/LazyCollection.html">LazyCollection</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/ConversationCollection.html">ConversationCollection</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/ConversationCollection/Reason.html">– Reason</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/MemberCollection.html">MemberCollection</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/ReceiptCollection.html">ReceiptCollection</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/EventCollection.html">EventCollection</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/EventCollection/Change.html">– Change</a>
              </li>
            </ul>
          </li>
          <li class="nav-group-name">
            <a href="Other Guides.html">Other Guides</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a href="changelog.html">CHANGELOG</a>
              </li>
              <li class="nav-group-task">
                <a href="designrationale.html">DesignRationale</a>
              </li>
              <li class="nav-group-task">
                <a href="readme.html">README</a>
              </li>
            </ul>
          </li>
          <li class="nav-group-name">
            <a href="Other Classes.html">Other Classes</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a href="Classes/AppLifecycleController.html">AppLifecycleController</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/AppLifecycleController/Notification.html">– Notification</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/Audio.html">Audio</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/Audio/State.html">– State</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/Audio/Errors.html">– Errors</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/AudioEvent.html">AudioEvent</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/MediaController.html">MediaController</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/PushNotificationController.html">PushNotificationController</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/RTCController.html">RTCController</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/RTCController/Media.html">– Media</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/Signal.html">Signal</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/SignalBase.html">SignalBase</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/SignalReference.html">SignalReference</a>
              </li>
            </ul>
          </li>
          <li class="nav-group-name">
            <a href="Other Enums.html">Other Enumerations</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a href="Enums/Change.html">Change</a>
              </li>
              <li class="nav-group-task">
                <a href="Enums/PushNotificationState.html">PushNotificationState</a>
              </li>
              <li class="nav-group-task">
                <a href="Enums/Result.html">Result</a>
              </li>
            </ul>
          </li>
          <li class="nav-group-name">
            <a href="Other Extensions.html">Other Extensions</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a href="Extensions/ObservableType.html">ObservableType</a>
              </li>
              <li class="nav-group-task">
                <a href="Extensions/PrimitiveSequence.html">PrimitiveSequence</a>
              </li>
            </ul>
          </li>
          <li class="nav-group-name">
            <a href="Other Protocols.html">Other Protocols</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a href="Protocols/Deletable.html">Deletable</a>
              </li>
              <li class="nav-group-task">
                <a href="Protocols/NetworkErrorProtocol.html">NetworkErrorProtocol</a>
              </li>
              <li class="nav-group-task">
                <a href="Protocols/RawDecodable.html">RawDecodable</a>
              </li>
            </ul>
          </li>
          <li class="nav-group-name">
            <a href="Other Structs.html">Other Structures</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a href="Structs/IPS.html">IPS</a>
              </li>
              <li class="nav-group-task">
                <a href="Structs/IPS/ImageType.html">– ImageType</a>
              </li>
              <li class="nav-group-task">
                <a href="Structs/Request.html">Request</a>
              </li>
            </ul>
          </li>
          <li class="nav-group-name">
            <a href="Other Typealiases.html">Other Type Aliases</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a href="Other Typealiases.html#/s:17NexmoConversation18RemoteNotificationa">RemoteNotification</a>
              </li>
            </ul>
          </li>
        </ul>
      </nav>
      <article class="main-content">
        <section>
          <section class="section">
            
            <h1 id='design-rationale' class='heading'>Design Rationale</h1>

<p>The purpose of this document is to give a high-level overview of various design patterns and decisions undertaken for the iOS SDK.</p>
<h3 id='architecture' class='heading'>Architecture</h3>

<p>The SDK is written following a multitier architecture (layered architecture) where the components within the layered architecture pattern are organised into horizontal layers, each layer performing a specific role and with its own responsibility. By using such an approach we&rsquo;re able to form an abstraction around the work that needs to be done to satisfy a particular business request.</p>

<p>One key benefit is the ability to have separation of concerns and conform to single responsibility principle among components. The Xcode project is set up to demonstrate this architecture as you can see from the folder structure. Its common to see layers such as routers, service, controller, managers and so on&hellip;</p>

<p>The concept follows the same direction as Apple&rsquo;s UIKit framework which uses the same architecture for the underlying hardware and the apps you create.</p>
<h4 id='common-design-patterns' class='heading'>Common design patterns</h4>

<p>Communication:  </p>

<ul>
<li>Incoming: async communication via WebSocket<br></li>
<li>Outgoing: rest request (HTTP 1.2)</li>
</ul>

<p>Storage:  </p>

<ul>
<li>Persistent storage (SQLite)<br></li>
<li>DAO<br></li>
<li>In-Memory lazy caching on both Mobile SDK<br></li>
</ul>

<p>Public interface:  </p>

<ul>
<li>Facade objects</li>
</ul>

<p>Observation Patterns:</p>

<ul>
<li>Swift (public/internal): Reactive programming (Rx)<br></li>
<li>Obj-c (public): Closure callback (onSucces: onFailure:)<br></li>
</ul>
<h3 id='language' class='heading'>Language</h3>

<p>All development of the SDK is in Swift language with a big focus on utilising Swifts many powerful features i.e enum, struct i.e enum, struct, generics, protocols etc. To support Objective-c backward compatibility we expose our Facade object as <code>@objc</code> and <code>NSObject</code>. Where the property/methods are only for Swift we create <code>Extension</code> and <code>wrappers</code> around them. Applications using Swift language should at all times prefer to use the Swift properties and methods.</p>

<p>A major design rationale we have undertaken in Swift is to use reactive(Rx) programming paradigm to better leverage events and chaining whilst in Objective-C providing a simple closure blocked base syntax.</p>

<p>Reactive (Rx) programming provides a way for composing asynchronous and event-based streams which can be observed or chained together. A stream is a sequence of ongoing events ordered in time. It can emit three different things: a value (of some type), an error, or a <q>completed</q> signal. The SDK uses <a href="RxSwift">https://github.com/ReactiveX/RxSwift</a> objects such as <code>Observables</code> and <code>Variable</code> object to help facilitate the use of reactive behaviour.</p>
<h4 id='observables-and-observers' class='heading'>Observables and Observers</h4>

<p>Two concepts to be aware of for this guide are the <code>Observable</code> and the <code>Observer</code>.
    - An <code>Observable</code> is something which emits notifications of change.
    - An <code>Observer</code> is something which subscribes to an Observable, in order to be notified when it has changed.
You can have multiple Observers listening to an Observable. This means that when the Observable changes, it will notify all its Observers.</p>

<p>Observing for change in client state i.e connected, sync etc.. To observe to an <code>Observable</code> object, we first have to call subscription or a high-order function like:</p>
<pre class="highlight swift"><code><span class="k">let</span> <span class="nv">client</span> <span class="o">=</span> <span class="kt">ConversationClient</span><span class="o">.</span><span class="n">instance</span>

<span class="c1">// observe for changes in client state</span>
<span class="n">client</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="nf">asObservable</span><span class="p">()</span><span class="o">.</span><span class="nf">subscribe</span><span class="p">(</span><span class="nv">onNext</span><span class="p">:</span> <span class="p">{</span> <span class="n">state</span> <span class="k">in</span>
    <span class="c1">// new state</span>
<span class="p">})</span><span class="o">.</span><span class="nf">addDisposableTo</span><span class="p">(</span><span class="n">client</span><span class="o">.</span><span class="n">disposeBag</span><span class="p">)</span>
</code></pre>

<p>The <code>.subscribe()</code> function allows developers to listen for the next result, errors and when it is complete</p>

<p>For Objective-c the following function would look like:</p>
<pre class="highlight swift"><code><span class="kt">NXMConversationClient</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="p">[</span><span class="kt">NXMConversationClient</span> <span class="n">instance</span><span class="p">];</span>

<span class="c1">// observe for changes in client state    </span>
<span class="p">[</span><span class="n">client</span> <span class="nv">stateObjc</span><span class="p">:</span><span class="o">^</span><span class="p">(</span><span class="kd">enum</span> <span class="kt">NXMStateObjc</span> <span class="n">state</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// new state</span>
<span class="p">}];</span> 
</code></pre>

<p>Observing for change in conversation collection</p>
<pre class="highlight plaintext"><code>// SDK
let client = ConversationClient.instance

client.conversation.conversations.asObservable.subscribe(onNext: { changes in
    switch changes {
    case .inserted(let conversations, let reason): break
    case .updated(let conversations): break
    case .deleted(let conversations): break
    }
}).addDisposableTo(client.disposeBag)
</code></pre>

<p>Chaining actions together i.e login, create conversation and than send a text event. Example of using Swift high order function to chain request together:  </p>
<pre class="highlight swift"><code><span class="k">let</span> <span class="nv">client</span> <span class="o">=</span> <span class="kt">ConversationClient</span><span class="o">.</span><span class="n">instance</span>

<span class="c1">// send a text event</span>
<span class="n">client</span>
    <span class="o">.</span><span class="nf">login</span><span class="p">(</span><span class="nv">with</span><span class="p">:</span> <span class="s">"TOKEN_HERE"</span><span class="p">)</span><span class="o">.</span><span class="nf">asObservable</span><span class="p">()</span>
    <span class="o">.</span><span class="n">flatMap</span> <span class="p">{</span> <span class="n">client</span><span class="o">.</span><span class="n">conversation</span><span class="o">.</span><span class="nf">new</span><span class="p">(</span><span class="s">"New conversation"</span><span class="p">,</span> <span class="nv">withJoin</span><span class="p">:</span> <span class="kc">true</span><span class="p">)</span><span class="o">.</span><span class="nf">asObservable</span><span class="p">()</span> <span class="p">}</span>
    <span class="o">.</span><span class="nf">do</span><span class="p">(</span><span class="nv">onNext</span><span class="p">:</span> <span class="p">{</span> <span class="n">_</span> <span class="o">=</span> <span class="nv">$0</span><span class="o">.</span><span class="nf">invite</span><span class="p">(</span><span class="s">"User 2"</span><span class="p">)</span><span class="o">.</span><span class="nf">subscribe</span><span class="p">()</span> <span class="p">})</span>
    <span class="o">.</span><span class="nf">subscribe</span><span class="p">(</span><span class="nv">onNext</span><span class="p">:</span> <span class="p">{</span> <span class="n">conversation</span> <span class="k">in</span>
        <span class="k">try</span><span class="p">?</span> <span class="n">conversation</span><span class="o">.</span><span class="nf">send</span><span class="p">(</span><span class="s">"Hello World!"</span><span class="p">)</span>
    <span class="p">})</span><span class="o">.</span><span class="nf">addDisposableTo</span><span class="p">(</span><span class="n">client</span><span class="o">.</span><span class="n">disposeBag</span><span class="p">)</span>
</code></pre>

<p>The following will first login, after that has been successful it will create a new conversation with join, invite a new user and then send a text event.</p>
<h4 id='dispose-bag' class='heading'>Dispose bag:</h4>

<p>All subscription requires a dispose bag to be returned to the calling function to help with memory references counting in Swift. Dispose bags are used to return ARC like behaviour to RxSwift, when a DisposeBag is deallocated (i.e when parent object called deinit) it will call dispose on each of the added disposables.</p>

          </section>
        </section>
        <section id="footer">
          <p>&copy; 2018 <a class="link" href="https://nexmo.com" target="_blank" rel="external">Nexmo</a>. All rights reserved. (Last updated: 2018-01-02)</p>
          <p>Generated by <a class="link" href="https://github.com/realm/jazzy" target="_blank" rel="external">jazzy ♪♫ v0.9.0</a>, a <a class="link" href="http://realm.io" target="_blank" rel="external">Realm</a> project.</p>
        </section>
      </article>
    </div>
  </body>
</div>
</html>
